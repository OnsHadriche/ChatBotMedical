<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Chatbot - Your Health Assistant</title>
    
    <!-- Preconnect for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.1/dist/css/bootstrap.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <!-- Skip to main content for accessibility -->
    <a href="#messageArea" class="skip-link">Skip to chat</a>

    <div class="container-fluid h-100">
        <div class="row justify-content-center h-100">
            <div class="col-md-8 col-xl-6 chat">
                <div class="card" role="main">
                    
                    <!-- Chat Header -->
                    <div class="card-header msg_head">
                        <div class="d-flex bd-highlight align-items-center">
                            <div class="img_cont">
                                <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" 
                                     class="rounded-circle user_img" 
                                     alt="Medical Chatbot Avatar"
                                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22%234A90A4%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2230%22>üè•</text></svg>'">
                                <span class="online_icon" aria-label="Online status: Active"></span>
                            </div>
                            <div class="user_info">
                                <span>Medical Chatbot</span>
                                <p id="statusText">
                                    <span class="status-dot"></span>
                                    Online - Ready to help
                                </p>
                            </div>
                        </div>
                        <div class="header_actions">
                            <button class="action_btn" id="clearChat" title="Clear chat history" aria-label="Clear chat">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <button class="action_btn" id="toggleTheme" title="Toggle theme" aria-label="Toggle dark/light theme">
                                <i class="fas fa-moon"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Chat Messages Area -->
                    <div id="messageFormeight" 
                         class="card-body msg_card_body" 
                         role="log" 
                         aria-live="polite"
                         aria-label="Chat messages">
                        
                        <!-- Welcome Message -->
                        <div class="welcome-message" id="welcomeMessage">
                            <div class="welcome-icon">
                                <i class="fas fa-hand-holding-medical"></i>
                            </div>
                            <h5>Welcome to Medical Chatbot!</h5>
                            <p>I'm here to help answer your health-related questions. Please note that I provide general information only and am not a substitute for professional medical advice.</p>
                            <div class="quick-actions">
                                <button class="quick-action-btn" data-message="What are common cold symptoms?">
                                    <i class="fas fa-thermometer-half"></i> Cold Symptoms
                                </button>
                                <button class="quick-action-btn" data-message="How can I improve my sleep?">
                                    <i class="fas fa-bed"></i> Sleep Tips
                                </button>
                                <button class="quick-action-btn" data-message="What should I eat for better health?">
                                    <i class="fas fa-apple-alt"></i> Nutrition
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Typing Indicator -->
                    <div id="typingIndicator" class="typing-indicator" style="display: none;">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <span>Medical Chatbot is typing...</span>
                    </div>

                    <!-- Chat Input Footer -->
                    <div class="card-footer">
                        <form id="messageArea" class="input-group" role="search">
                            <label for="text" class="sr-only">Type your message</label>
                            <input type="text" 
                                   id="text" 
                                   name="msg"
                                   placeholder="Type your health question..."
                                   autocomplete="off"
                                   class="form-control type_msg" 
                                   required
                                   aria-label="Message input"
                                   maxlength="500">
                            <div class="input-group-append">
                                <button type="submit" 
                                        id="send" 
                                        class="input-group-text send_btn" 
                                        title="Send message (Enter)"
                                        aria-label="Send message">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                        <div class="input-hints">
                            <span><kbd>Enter</kbd> to send</span>
                            <span id="charCount">0/500</span>
                        </div>
                    </div>

                </div>
                
                <!-- Disclaimer -->
                <div class="disclaimer">
                    <i class="fas fa-info-circle"></i>
                    <span>This chatbot provides general information only. Always consult a healthcare professional for medical advice.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-notification" role="alert" aria-live="assertive">
        <span id="toastMessage"></span>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.1/dist/js/bootstrap.min.js"></script>

    <script>
    $(document).ready(function () {
        const $messageArea = $("#messageArea");
        const $textInput = $("#text");
        const $chatBody = $("#messageFormeight");
        const $typingIndicator = $("#typingIndicator");
        const $welcomeMessage = $("#welcomeMessage");
        const $charCount = $("#charCount");
        const $body = $("body");
        const $themeBtn = $("#toggleTheme");
        const maxChars = 500;

        // ==========================================
        // Theme Management with localStorage
        // ==========================================
        
        // Load saved theme on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('chatbot-theme');
            
            if (savedTheme === 'light') {
                $body.addClass('light-theme');
                $themeBtn.find('i').removeClass('fa-moon').addClass('fa-sun');
            } else {
                // Default to dark theme
                $body.removeClass('light-theme');
                $themeBtn.find('i').removeClass('fa-sun').addClass('fa-moon');
            }
        }

        // Save theme to localStorage
        function saveTheme(theme) {
            localStorage.setItem('chatbot-theme', theme);
        }

        // Check if current theme is light
        function isLightTheme() {
            return $body.hasClass('light-theme');
        }

        // Toggle theme
        function toggleTheme() {
            if (isLightTheme()) {
                // Switch to dark
                $body.removeClass('light-theme');
                $themeBtn.find('i').removeClass('fa-sun').addClass('fa-moon');
                saveTheme('dark');
                showToast("Dark theme enabled", "info");
            } else {
                // Switch to light
                $body.addClass('light-theme');
                $themeBtn.find('i').removeClass('fa-moon').addClass('fa-sun');
                saveTheme('light');
                showToast("Light theme enabled", "info");
            }
        }

        // Initialize theme on page load
        loadTheme();

        // Theme toggle button click
        $themeBtn.on("click", toggleTheme);

        // ==========================================
        // Utility Functions
        // ==========================================

        // Format time with leading zeros
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const $toast = $("#toast");
            const $toastMessage = $("#toastMessage");
            $toast.removeClass('success error info').addClass(type);
            $toastMessage.text(message);
            $toast.addClass('show');
            setTimeout(() => $toast.removeClass('show'), 3000);
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            $chatBody.animate({ scrollTop: $chatBody[0].scrollHeight }, 300);
        }

        // Hide welcome message
        function hideWelcome() {
            $welcomeMessage.fadeOut(300);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ==========================================
        // Event Handlers
        // ==========================================

        // Update character count
        $textInput.on('input', function() {
            const length = $(this).val().length;
            $charCount.text(`${length}/${maxChars}`);
            if (length > maxChars * 0.9) {
                $charCount.addClass('warning');
            } else {
                $charCount.removeClass('warning');
            }
        });

        // Quick action buttons
        $(".quick-action-btn").on("click", function() {
            const message = $(this).data("message");
            $textInput.val(message);
            $messageArea.submit();
        });

        // Clear chat
        $("#clearChat").on("click", function() {
            if (confirm("Are you sure you want to clear the chat history?")) {
                $chatBody.find(".d-flex").remove();
                $welcomeMessage.fadeIn(300);
                showToast("Chat cleared", "success");
            }
        });

        // Store last message for retry
        let lastMessage = "";

        // Message submission
        $messageArea.on("submit", function (event) {
            event.preventDefault();

            const rawText = $textInput.val().trim();
            if (!rawText) return;

            // Store for retry functionality
            lastMessage = rawText;

            hideWelcome();
            const strTime = formatTime(new Date());

            // User message HTML with animation
            const userHtml = `
            <div class="d-flex justify-content-end mb-4 message-animation">
                <div class="msg_cotainer_send">
                    <p class="msg_text">${escapeHtml(rawText)}</p>
                    <span class="msg_time_send">${strTime}</span>
                </div>
                <div class="img_cont_msg">
                    <img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" 
                        class="rounded-circle user_img_msg" 
                        alt="Your avatar"
                        onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22%2358cc71%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2240%22>üë§</text></svg>'">
                </div>
            </div>`;

            $textInput.val("").focus();
            $charCount.text("0/500").removeClass("warning");
            $chatBody.append(userHtml);
            scrollToBottom();

            // Show typing indicator
            $typingIndicator.fadeIn(200);
            $("#statusText").html('<span class="status-dot typing"></span> Typing...');

            // Send request
            $.ajax({
                url: "/get_msg_chat_medical",
                method: "POST",
                data: { msg: rawText },
                timeout: 30000
            })
            .done(function (data) {
                const botHtml = `
                <div class="d-flex justify-content-start mb-4 message-animation">
                    <div class="img_cont_msg">
                        <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" 
                            class="rounded-circle user_img_msg"
                            alt="Bot avatar"
                            onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22%234A90A4%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2230%22>üè•</text></svg>'">
                    </div>
                    <div class="msg_cotainer">
                        <p class="msg_text">${data}</p>
                        <span class="msg_time">${formatTime(new Date())}</span>
                    </div>
                </div>`;
                $chatBody.append(botHtml);
                scrollToBottom();
            })
            .fail(function (jqXHR, textStatus) {
                let errorMsg = "Sorry, something went wrong. Please try again.";
                if (textStatus === "timeout") {
                    errorMsg = "Request timed out. Please try again.";
                }
                
                const errorHtml = `
                <div class="d-flex justify-content-start mb-4 message-animation">
                    <div class="img_cont_msg">
                        <img src="https://cdn-icons-png.flaticon.com/512/387/387569.png" 
                            class="rounded-circle user_img_msg"
                            alt="Bot avatar">
                    </div>
                    <div class="msg_cotainer error">
                        <p class="msg_text"><i class="fas fa-exclamation-circle"></i> ${errorMsg}</p>
                        <button class="retry-btn" onclick="retryLastMessage()">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                </div>`;
                $chatBody.append(errorHtml);
                scrollToBottom();
                showToast(errorMsg, "error");
            })
            .always(function() {
                $typingIndicator.fadeOut(200);
                $("#statusText").html('<span class="status-dot"></span> Online - Ready to help');
            });
        });

        // Retry last message function (global scope)
        window.retryLastMessage = function() {
            if (lastMessage) {
                $textInput.val(lastMessage);
                $messageArea.submit();
            }
        };

        // Focus input on page load
        $textInput.focus();

        // Keyboard shortcuts
        $(document).on('keydown', function(e) {
            // Ctrl + / to focus input
            if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                $textInput.focus();
            }
            // Ctrl + Shift + L to toggle theme
            if (e.ctrlKey && e.shiftKey && e.key === 'L') {
                e.preventDefault();
                toggleTheme();
            }
        });
    });
    </script>

</body>
</html>