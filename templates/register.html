<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Medical Chatbot</title>
    
    <!-- Apply theme immediately to prevent flash -->
    <script>
        (function() {
            try {
                const savedTheme = localStorage.getItem('chatbot-theme');
                if (savedTheme === 'light') {
                    document.documentElement.classList.add('light-theme');
                }
            } catch (e) {
                console.warn('Could not access localStorage:', e);
            }
        })();
    </script>
    
    <!-- Preconnect for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.1/dist/css/bootstrap.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='auth.css') }}">
</head>

<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="toggleTheme" title="Toggle theme" aria-label="Toggle dark/light theme">
        <i class="fas fa-moon"></i>
    </button>

    <div class="auth-container">
        <!-- Left Side - Branding -->
        <div class="auth-branding">
            <div class="branding-content">
                <div class="brand-logo">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <h1>Medical Chatbot</h1>
                <p>Join thousands of users who trust our AI-powered health assistant for reliable health information.</p>
                
                <div class="features">
                    <div class="feature-item">
                        <i class="fas fa-shield-alt"></i>
                        <span>HIPAA Compliant Security</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-history"></i>
                        <span>Chat History Saved</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-user-md"></i>
                        <span>Personalized Experience</span>
                    </div>
                    <div class="feature-item">
                        <i class="fas fa-mobile-alt"></i>
                        <span>Access from Any Device</span>
                    </div>
                </div>
            </div>
            
            <div class="branding-footer">
                <p>&copy; 2024 Medical Chatbot. All rights reserved.</p>
            </div>
        </div>

        <!-- Right Side - Register Form -->
        <div class="auth-form-container">
            <div class="auth-form-wrapper">
                <div class="auth-header">
                    <h2>Create Account</h2>
                    <p>Start your health journey with us</p>
                </div>

                <!-- Alert Messages -->
                <div id="alertMessage" class="alert-message" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="alertText"></span>
                    <button class="alert-close" onclick="hideAlert()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Progress Steps -->
                <div class="progress-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <span>Personal Info</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <span>Security</span>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <span>Complete</span>
                    </div>
                </div>

                <form id="registerForm" class="auth-form" novalidate>
                    <!-- Step 1: Personal Information -->
                    <div class="form-step active" data-step="1">
                        <!-- Full Name Field -->
                        <div class="form-group">
                            <label for="fullname">Full Name</label>
                            <div class="input-wrapper">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" 
                                       id="fullname" 
                                       name="fullname" 
                                       placeholder="Enter your full name"
                                       autocomplete="name"
                                       required>
                                <i class="fas fa-check-circle input-valid-icon"></i>
                            </div>
                            <span class="error-message" id="fullnameError"></span>
                        </div>

                        <!-- Email Field -->
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <div class="input-wrapper">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" 
                                       id="email" 
                                       name="email" 
                                       placeholder="Enter your email"
                                       autocomplete="email"
                                       required>
                                <i class="fas fa-check-circle input-valid-icon"></i>
                            </div>
                            <span class="error-message" id="emailError"></span>
                        </div>

                        <!-- Phone Number (Optional) -->
                        <div class="form-group">
                            <label for="phone">Phone Number <span class="optional">(Optional)</span></label>
                            <div class="input-wrapper">
                                <i class="fas fa-phone input-icon"></i>
                                <input type="tel" 
                                       id="phone" 
                                       name="phone" 
                                       placeholder="Enter your phone number"
                                       autocomplete="tel">
                                <i class="fas fa-check-circle input-valid-icon"></i>
                            </div>
                            <span class="error-message" id="phoneError"></span>
                        </div>

                        <button type="button" class="btn-primary" onclick="nextStep(1)">
                            <span class="btn-text">Continue</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                    <!-- Step 2: Security -->
                    <div class="form-step" data-step="2">
                        <!-- Password Field -->
                        <div class="form-group">
                            <label for="password">Password</label>
                            <div class="input-wrapper">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" 
                                       id="password" 
                                       name="password" 
                                       placeholder="Create a strong password"
                                       autocomplete="new-password"
                                       required
                                       minlength="8">
                                <button type="button" class="password-toggle" onclick="togglePassword('password')" title="Show/Hide password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span class="error-message" id="passwordError"></span>
                            
                            <!-- Password Strength Indicator -->
                            <div class="password-strength">
                                <div class="strength-bar">
                                    <div class="strength-fill" id="strengthFill"></div>
                                </div>
                                <span class="strength-text" id="strengthText">Password strength</span>
                            </div>

                            <!-- Password Requirements -->
                            <div class="password-requirements">
                                <div class="requirement" id="req-length">
                                    <i class="fas fa-circle"></i>
                                    <span>At least 8 characters</span>
                                </div>
                                <div class="requirement" id="req-uppercase">
                                    <i class="fas fa-circle"></i>
                                    <span>One uppercase letter</span>
                                </div>
                                <div class="requirement" id="req-lowercase">
                                    <i class="fas fa-circle"></i>
                                    <span>One lowercase letter</span>
                                </div>
                                <div class="requirement" id="req-number">
                                    <i class="fas fa-circle"></i>
                                    <span>One number</span>
                                </div>
                                <div class="requirement" id="req-special">
                                    <i class="fas fa-circle"></i>
                                    <span>One special character</span>
                                </div>
                            </div>
                        </div>

                        <!-- Confirm Password Field -->
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <div class="input-wrapper">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" 
                                       id="confirmPassword" 
                                       name="confirmPassword" 
                                       placeholder="Confirm your password"
                                       autocomplete="new-password"
                                       required>
                                <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')" title="Show/Hide password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span class="error-message" id="confirmPasswordError"></span>
                        </div>

                        <div class="form-buttons">
                            <button type="button" class="btn-secondary" onclick="prevStep(2)">
                                <i class="fas fa-arrow-left"></i>
                                <span>Back</span>
                            </button>
                            <button type="button" class="btn-primary" onclick="nextStep(2)">
                                <span class="btn-text">Continue</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Terms & Complete -->
                    <div class="form-step" data-step="3">
                        <!-- Account Summary -->
                        <div class="account-summary">
                            <h4><i class="fas fa-user-check"></i> Account Summary</h4>
                            <div class="summary-item">
                                <span class="summary-label">Name:</span>
                                <span class="summary-value" id="summaryName">-</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Email:</span>
                                <span class="summary-value" id="summaryEmail">-</span>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="form-group">
                            <label class="checkbox-wrapper terms-checkbox">
                                <input type="checkbox" id="terms" name="terms" required>
                                <span class="checkmark"></span>
                                <span class="checkbox-label">
                                    I agree to the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a>
                                </span>
                            </label>
                            <span class="error-message" id="termsError"></span>
                        </div>

                        <!-- Newsletter -->
                        <div class="form-group">
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="newsletter" name="newsletter">
                                <span class="checkmark"></span>
                                <span class="checkbox-label">
                                    Subscribe to health tips and updates
                                </span>
                            </label>
                        </div>

                        <div class="form-buttons">
                            <button type="button" class="btn-secondary" onclick="prevStep(3)">
                                <i class="fas fa-arrow-left"></i>
                                <span>Back</span>
                            </button>
                            <button type="submit" class="btn-primary" id="registerBtn">
                                <span class="btn-text">Create Account</span>
                                <span class="btn-loader" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Divider -->
                <div class="divider">
                    <span>or sign up with</span>
                </div>

                <!-- Social Login -->
                <div class="social-login">
                    <button type="button" class="btn-social google" onclick="socialLogin('google')">
                        <i class="fab fa-google"></i>
                        <span>Google</span>
                    </button>
                    <button type="button" class="btn-social facebook" onclick="socialLogin('facebook')">
                        <i class="fab fa-facebook-f"></i>
                        <span>Facebook</span>
                    </button>
                    <button type="button" class="btn-social twitter" onclick="socialLogin('twitter')">
                        <i class="fab fa-twitter"></i>
                        <span>Twitter</span>
                    </button>
                </div>

                <!-- Login Link -->
                <div class="auth-footer">
                    <p>Already have an account? <a href="/login">Sign In</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-notification" role="alert" aria-live="assertive">
        <i class="toast-icon fas fa-info-circle"></i>
        <span id="toastMessage"></span>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <script>
    $(document).ready(function() {
        const $body = $("body");
        const $themeBtn = $("#toggleTheme");
        const $registerForm = $("#registerForm");
        let currentStep = 1;

        // ==========================================
        // Theme Management
        // ==========================================
        function loadTheme() {
            const savedTheme = localStorage.getItem('chatbot-theme');
            if (savedTheme === 'light') {
                $body.addClass('light-theme');
                $themeBtn.find('i').removeClass('fa-moon').addClass('fa-sun');
            }
        }

        function toggleTheme() {
            const isLight = $body.hasClass('light-theme');
            if (isLight) {
                $body.removeClass('light-theme');
                $themeBtn.find('i').removeClass('fa-sun').addClass('fa-moon');
                localStorage.setItem('chatbot-theme', 'dark');
                showToast("Dark theme enabled", "info");
            } else {
                $body.addClass('light-theme');
                $themeBtn.find('i').removeClass('fa-moon').addClass('fa-sun');
                localStorage.setItem('chatbot-theme', 'light');
                showToast("Light theme enabled", "info");
            }
        }

        loadTheme();
        $themeBtn.on("click", toggleTheme);

        // ==========================================
        // Password Strength Checker
        // ==========================================
        $("#password").on("input", function() {
            const password = $(this).val();
            checkPasswordStrength(password);
            checkPasswordRequirements(password);
        });

        function checkPasswordStrength(password) {
            let strength = 0;
            const $fill = $("#strengthFill");
            const $text = $("#strengthText");

            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/)) strength++;
            if (password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;

            const percentage = (strength / 5) * 100;
            $fill.css('width', percentage + '%');

            $fill.removeClass('weak medium strong very-strong');
            $text.removeClass('weak medium strong very-strong');

            if (strength <= 1) {
                $fill.addClass('weak');
                $text.addClass('weak').text('Weak');
            } else if (strength <= 2) {
                $fill.addClass('medium');
                $text.addClass('medium').text('Fair');
            } else if (strength <= 3) {
                $fill.addClass('strong');
                $text.addClass('strong').text('Good');
            } else {
                $fill.addClass('very-strong');
                $text.addClass('very-strong').text('Strong');
            }
        }

        function checkPasswordRequirements(password) {
            updateRequirement('req-length', password.length >= 8);
            updateRequirement('req-uppercase', /[A-Z]/.test(password));
            updateRequirement('req-lowercase', /[a-z]/.test(password));
            updateRequirement('req-number', /[0-9]/.test(password));
            updateRequirement('req-special', /[^a-zA-Z0-9]/.test(password));
        }

        function updateRequirement(id, met) {
            const $req = $(`#${id}`);
            const $icon = $req.find('i');
            if (met) {
                $req.addClass('met');
                $icon.removeClass('fa-circle').addClass('fa-check-circle');
            } else {
                $req.removeClass('met');
                $icon.removeClass('fa-check-circle').addClass('fa-circle');
            }
        }

        // ==========================================
        // Form Validation
        // ==========================================
        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function validatePhone(phone) {
            if (!phone) return true; // Optional field
            const regex = /^[\d\s\-+()]{10,}$/;
            return regex.test(phone);
        }

        function showError(fieldId, message) {
            const $field = $(`#${fieldId}`);
            const $error = $(`#${fieldId}Error`);
            $field.addClass('invalid').removeClass('valid');
            $error.text(message).addClass('show');
        }

        function showSuccess(fieldId) {
            const $field = $(`#${fieldId}`);
            const $error = $(`#${fieldId}Error`);
            $field.removeClass('invalid').addClass('valid');
            $error.removeClass('show');
        }

        function clearValidation(fieldId) {
            const $field = $(`#${fieldId}`);
            const $error = $(`#${fieldId}Error`);
            $field.removeClass('invalid valid');
            $error.removeClass('show');
        }

        // Clear validation on focus
        $("input").on("focus", function() {
            clearValidation($(this).attr('id'));
        });

        // Form submission
        $registerForm.on("submit", function(e) {
            e.preventDefault();

            const terms = $("#terms").is(':checked');
            
            if (!terms) {
                showError('terms', 'You must agree to the terms and conditions');
                return;
            }

            // Show loading state
            const $btn = $("#registerBtn");
            $btn.prop('disabled', true);
            $btn.find('.btn-text').hide();
            $btn.find('.btn-loader').show();

            // Simulate API call
            $.ajax({
                url:"/register",
                method:'POST',
                contentType:'application/json',
                data:JSON.stringify({
                    fullname :  $("#fullname").val().trim(),
                    email:      $("#email").val().trim(),
                    phone:      $("#phone").val().trim(),
                    password:   $("#password").val(),
                    newsletter: $("#newsletter").is(':checked')
                }),
                success: function(response) {
                    console.log("✅ Success:", response);
                    showToast("Account created! Redirecting...", "success");
                    setTimeout(() => window.location.href = response.redirect, 1500);
                },
                error: function(xhr) {
                    console.log("❌ Error:", xhr.responseJSON);
                    const msg = xhr.responseJSON?.message || 'Registration failed';
                    showAlert(msg, 'error');
                    $btn.prop('disabled', false);
                    $btn.find('.btn-text').show();
                    $btn.find('.btn-loader').hide();
                }
            })
        });

        // ==========================================
        // Utility Functions
        // ==========================================
        function showToast(message, type = 'info') {
            const $toast = $("#toast");
            const $toastMessage = $("#toastMessage");
            const $toastIcon = $toast.find('.toast-icon');
            
            $toast.removeClass('success error info').addClass(type);
            $toastMessage.text(message);
            
            $toastIcon.removeClass('fa-check-circle fa-exclamation-circle fa-info-circle');
            if (type === 'success') {
                $toastIcon.addClass('fa-check-circle');
            } else if (type === 'error') {
                $toastIcon.addClass('fa-exclamation-circle');
            } else {
                $toastIcon.addClass('fa-info-circle');
            }
            
            $toast.addClass('show');
            setTimeout(() => $toast.removeClass('show'), 3000);
        }

        // Make showToast available globally
        window.showToast = showToast;
        window.showError = showError;
        window.showSuccess = showSuccess;
        window.validateEmail = validateEmail;
        window.validatePhone = validatePhone;
    });

    // ==========================================
    // Step Navigation
    // ==========================================
    function nextStep(current) {
        if (!validateStep(current)) return;

        const next = current + 1;
        
        // Update form steps
        $(`.form-step[data-step="${current}"]`).removeClass('active');
        $(`.form-step[data-step="${next}"]`).addClass('active');
        
        // Update progress steps
        $(`.step[data-step="${current}"]`).addClass('completed');
        $(`.step[data-step="${next}"]`).addClass('active');

        // Update summary on step 3
        if (next === 3) {
            $("#summaryName").text($("#fullname").val());
            $("#summaryEmail").text($("#email").val());
        }
    }

    function prevStep(current) {
        const prev = current - 1;
        
        $(`.form-step[data-step="${current}"]`).removeClass('active');
        $(`.form-step[data-step="${prev}"]`).addClass('active');
        
        $(`.step[data-step="${current}"]`).removeClass('active');
        $(`.step[data-step="${prev}"]`).removeClass('completed').addClass('active');
    }

    function validateStep(step) {
        let isValid = true;

        if (step === 1) {
            const fullname = $("#fullname").val().trim();
            const email = $("#email").val().trim();
            const phone = $("#phone").val().trim();

            if (!fullname) {
                showError('fullname', 'Full name is required');
                isValid = false;
            } else if (fullname.length < 2) {
                showError('fullname', 'Name must be at least 2 characters');
                isValid = false;
            } else {
                showSuccess('fullname');
            }

            if (!email) {
                showError('email', 'Email is required');
                isValid = false;
            } else if (!validateEmail(email)) {
                showError('email', 'Please enter a valid email address');
                isValid = false;
            } else {
                showSuccess('email');
            }

            if (phone && !validatePhone(phone)) {
                showError('phone', 'Please enter a valid phone number');
                isValid = false;
            } else if (phone) {
                showSuccess('phone');
            }
        }

        if (step === 2) {
            const password = $("#password").val();
            const confirmPassword = $("#confirmPassword").val();

            if (!password) {
                showError('password', 'Password is required');
                isValid = false;
            } else if (password.length < 8) {
                showError('password', 'Password must be at least 8 characters');
                isValid = false;
            } else if (!/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/[0-9]/.test(password)) {
                showError('password', 'Password must contain uppercase, lowercase and numbers');
                isValid = false;
            } else {
                showSuccess('password');
            }

            if (!confirmPassword) {
                showError('confirmPassword', 'Please confirm your password');
                isValid = false;
            } else if (password !== confirmPassword) {
                showError('confirmPassword', 'Passwords do not match');
                isValid = false;
            } else {
                showSuccess('confirmPassword');
            }
        }

        return isValid;
    }

    // Toggle password visibility
    function togglePassword(fieldId) {
        const $field = $(`#${fieldId}`);
        const $icon = $field.siblings('.password-toggle').find('i');
        
        if ($field.attr('type') === 'password') {
            $field.attr('type', 'text');
            $icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            $field.attr('type', 'password');
            $icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    }

    // Social login handlers
    function socialLogin(provider) {
        console.log('Social login with:', provider);
    }

    // Alert functions
    function showAlert(message, type = 'info') {
        const $alert = $("#alertMessage");
        const $alertText = $("#alertText");
        $alert.removeClass('success error info').addClass(type);
        $alertText.text(message);
        $alert.slideDown(300);
    }

    function hideAlert() {
        $("#alertMessage").slideUp(300);
    }
    </script>
</body>
</html>