<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Medical Chatbot</title>

    <!-- Apply theme immediately -->
    <script>
        (function() {
            try {
                if (localStorage.getItem('chatbot-theme') === 'light')
                    document.documentElement.classList.add('light-theme');
            } catch(e) {}
        })();
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css">

    <style>
        /* ==========================================
           CSS VARIABLES
        ========================================== */
        :root {
            --bg:           #080c14;
            --bg-card:      #0f1623;
            --bg-input:     #161e2e;
            --bg-hover:     #1a2438;
            --accent:       #4f8ef7;
            --accent-glow:  rgba(79, 142, 247, 0.25);
            --accent-hover: #6ba3ff;
            --success:      #22c55e;
            --success-glow: rgba(34, 197, 94, 0.2);
            --error:        #ef4444;
            --error-glow:   rgba(239, 68, 68, 0.2);
            --text-1:       #f0f4ff;
            --text-2:       #8896b3;
            --text-3:       #4a5568;
            --border:       rgba(255,255,255,0.06);
            --border-focus: rgba(79, 142, 247, 0.5);
            --radius:       16px;
            --radius-sm:    10px;
            --transition:   0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        html.light-theme {
            --bg:           #eef2fa;
            --bg-card:      #ffffff;
            --bg-input:     #f1f5fd;
            --bg-hover:     #e8eef8;
            --accent:       #2563eb;
            --accent-glow:  rgba(37, 99, 235, 0.15);
            --accent-hover: #3b7eff;
            --text-1:       #0f172a;
            --text-2:       #475569;
            --text-3:       #94a3b8;
            --border:       rgba(0,0,0,0.08);
            --border-focus: rgba(37, 99, 235, 0.4);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text-1);
            transition: background var(--transition), color var(--transition);
        }

        /* ==========================================
           BACKGROUND DECORATION
        ========================================== */
        .bg-decoration {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.12;
        }

        .bg-orb-1 {
            width: 500px; height: 500px;
            background: var(--accent);
            top: -150px; left: -100px;
            animation: orbFloat 8s ease-in-out infinite;
        }

        .bg-orb-2 {
            width: 350px; height: 350px;
            background: #a855f7;
            bottom: -100px; right: -80px;
            animation: orbFloat 10s ease-in-out infinite reverse;
        }

        .bg-grid {
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        html.light-theme .bg-grid {
            background-image:
                linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50%       { transform: translate(20px, -20px) scale(1.05); }
        }

        /* ==========================================
           LAYOUT
        ========================================== */
        .page-wrapper {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .card {
            width: 100%;
            max-width: 440px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 24px 64px rgba(0,0,0,0.4);
            animation: cardIn 0.4s cubic-bezier(0.34, 1.2, 0.64, 1);
        }

        @keyframes cardIn {
            from { opacity: 0; transform: translateY(24px) scale(0.97); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* ==========================================
           THEME TOGGLE
        ========================================== */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: var(--text-2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            z-index: 100;
            transition: all var(--transition);
        }

        .theme-toggle:hover {
            color: var(--accent);
            border-color: var(--border-focus);
            box-shadow: 0 0 12px var(--accent-glow);
        }

        /* ==========================================
           PROGRESS STEPS
        ========================================== */
        .steps-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            margin-bottom: 36px;
        }

        .step-pill {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-input);
            color: var(--text-3);
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.35s ease;
            flex-shrink: 0;
        }

        .step-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-3);
            transition: color 0.35s ease;
            white-space: nowrap;
        }

        .step-line {
            flex: 1;
            height: 2px;
            background: var(--border);
            margin: 0 10px;
            border-radius: 1px;
            overflow: hidden;
            min-width: 30px;
            max-width: 60px;
            position: relative;
        }

        .step-line-fill {
            height: 100%;
            width: 0%;
            background: var(--accent);
            border-radius: 1px;
            transition: width 0.5s ease;
        }

        /* Active step */
        .step-pill.active .step-circle {
            border-color: var(--accent);
            background: var(--accent-glow);
            color: var(--accent);
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .step-pill.active .step-label { color: var(--accent); }

        /* Completed step */
        .step-pill.completed .step-circle {
            border-color: var(--success);
            background: var(--success-glow);
            color: var(--success);
        }

        .step-pill.completed .step-label { color: var(--success); }

        /* ==========================================
           ICON HEADER
        ========================================== */
        .icon-header {
            text-align: center;
            margin-bottom: 28px;
        }

        .icon-wrap {
            width: 68px;
            height: 68px;
            margin: 0 auto 18px;
            border-radius: 20px;
            background: var(--accent-glow);
            border: 1px solid var(--border-focus);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            color: var(--accent);
            position: relative;
            transition: all 0.35s ease;
        }

        .icon-wrap.success-icon {
            background: var(--success-glow);
            border-color: rgba(34, 197, 94, 0.4);
            color: var(--success);
        }

        .icon-wrap::after {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 26px;
            border: 1px solid var(--border-focus);
            opacity: 0.4;
        }

        .icon-wrap.success-icon::after {
            border-color: rgba(34, 197, 94, 0.3);
        }

        .step-title {
            font-family: 'Fraunces', serif;
            font-size: 26px;
            font-weight: 600;
            color: var(--text-1);
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }

        .step-desc {
            font-size: 14px;
            color: var(--text-2);
            line-height: 1.6;
        }

        .step-desc strong {
            color: var(--accent);
            font-weight: 600;
        }

        /* ==========================================
           FORM ELEMENTS
        ========================================== */
        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-2);
            margin-bottom: 8px;
        }

        .input-wrap {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-3);
            font-size: 14px;
            pointer-events: none;
            transition: color var(--transition);
        }

        .form-input {
            width: 100%;
            padding: 12px 14px 12px 42px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-1);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            outline: none;
            transition: all var(--transition);
        }

        .form-input:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-input:focus + .input-focus-ring { opacity: 1; }

        .form-input::placeholder { color: var(--text-3); }

        .form-input.invalid {
            border-color: var(--error);
            box-shadow: 0 0 0 3px var(--error-glow);
        }

        .form-input.valid {
            border-color: var(--success);
        }

        .input-wrap:focus-within .input-icon { color: var(--accent); }

        .error-msg {
            font-size: 12px;
            color: var(--error);
            margin-top: 6px;
            display: none;
            align-items: center;
            gap: 4px;
        }

        .error-msg.show { display: flex; }

        /* ==========================================
           OTP INPUT
        ========================================== */
        .otp-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 8px 0;
        }

        .otp-input {
            width: 52px;
            height: 58px;
            text-align: center;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-1);
            font-family: 'Fraunces', serif;
            font-size: 22px;
            font-weight: 600;
            outline: none;
            transition: all var(--transition);
            caret-color: var(--accent);
        }

        .otp-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
            background: var(--bg-hover);
        }

        .otp-input.filled {
            border-color: var(--accent);
            color: var(--accent);
        }

        .otp-input.invalid {
            border-color: var(--error);
            box-shadow: 0 0 0 3px var(--error-glow);
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60%  { transform: translateX(-4px); }
            40%, 80%  { transform: translateX(4px); }
        }

        .resend-row {
            text-align: center;
            margin-top: 16px;
            font-size: 13px;
            color: var(--text-2);
        }

        .resend-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 600;
            padding: 0;
            transition: color var(--transition);
        }

        .resend-btn:hover { color: var(--accent-hover); }
        .resend-btn:disabled { color: var(--text-3); cursor: default; }

        #resendTimer { color: var(--accent); font-weight: 600; }

        /* ==========================================
           PASSWORD STRENGTH
        ========================================== */
        .strength-bar-wrap {
            margin-top: 10px;
        }

        .strength-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            border-radius: 2px;
            transition: width 0.3s ease, background 0.3s ease;
        }

        .strength-fill.weak    { background: var(--error);   width: 25%; }
        .strength-fill.fair    { background: #f97316;        width: 50%; }
        .strength-fill.good    { background: #eab308;        width: 75%; }
        .strength-fill.strong  { background: var(--success); width: 100%; }

        .strength-text {
            font-size: 11px;
            color: var(--text-3);
            font-weight: 500;
        }

        .strength-text.weak    { color: var(--error); }
        .strength-text.fair    { color: #f97316; }
        .strength-text.good    { color: #eab308; }
        .strength-text.strong  { color: var(--success); }

        /* Requirements checklist */
        .req-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 12px;
        }

        .req-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-3);
            transition: color 0.2s;
        }

        .req-item.met { color: var(--success); }

        .req-item i {
            font-size: 10px;
            width: 14px;
        }

        /* Password toggle */
        .pw-toggle {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-3);
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            transition: color var(--transition);
        }

        .pw-toggle:hover { color: var(--accent); }

        /* ==========================================
           BUTTONS
        ========================================== */
        .btn-primary {
            width: 100%;
            padding: 13px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: var(--radius-sm);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
            letter-spacing: 0.2px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.1);
            opacity: 0;
            transition: opacity var(--transition);
        }

        .btn-primary:hover::after { opacity: 1; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 20px var(--accent-glow); }
        .btn-primary:active { transform: translateY(0); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-loader { display: none; }
        .btn-loader i { animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Back link */
        .back-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 20px;
            font-size: 13px;
            color: var(--text-2);
            text-decoration: none;
            transition: color var(--transition);
        }

        .back-link:hover { color: var(--accent); text-decoration: none; }

        /* ==========================================
           SUCCESS STATE
        ========================================== */
        .success-state {
            text-align: center;
            padding: 10px 0;
        }

        .success-checkmark {
            width: 72px;
            height: 72px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: var(--success-glow);
            border: 2px solid rgba(34, 197, 94, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: var(--success);
            animation: checkPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes checkPop {
            from { opacity: 0; transform: scale(0.5); }
            to   { opacity: 1; transform: scale(1); }
        }

        .success-title {
            font-family: 'Fraunces', serif;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-1);
            margin-bottom: 10px;
        }

        .success-desc {
            font-size: 14px;
            color: var(--text-2);
            line-height: 1.7;
            margin-bottom: 28px;
        }

        .btn-login {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 32px;
            background: var(--accent);
            color: #fff;
            border-radius: var(--radius-sm);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all var(--transition);
        }

        .btn-login:hover {
            background: var(--accent-hover);
            color: #fff;
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 8px 20px var(--accent-glow);
        }

        /* ==========================================
           ALERT
        ========================================== */
        .alert {
            display: none;
            padding: 12px 14px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            margin-bottom: 20px;
            align-items: center;
            gap: 10px;
            border: 1px solid;
        }

        .alert.show { display: flex; }

        .alert.error {
            background: var(--error-glow);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .alert.success {
            background: var(--success-glow);
            border-color: rgba(34, 197, 94, 0.3);
            color: var(--success);
        }

        /* ==========================================
           TOAST
        ========================================== */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--text-1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(12px);
            transition: all var(--transition);
            z-index: 9999;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { border-color: rgba(34, 197, 94, 0.4); color: var(--success); }
        .toast.error   { border-color: rgba(239, 68, 68, 0.4); color: var(--error); }

        /* ==========================================
           STEP PANELS
        ========================================== */
        .step-panel { display: none; }
        .step-panel.active { display: block; animation: fadeSlide 0.3s ease; }

        @keyframes fadeSlide {
            from { opacity: 0; transform: translateX(12px); }
            to   { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>

<!-- Background -->
<div class="bg-decoration">
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-grid"></div>
</div>

<!-- Theme Toggle -->
<button class="theme-toggle" id="themeToggle" title="Toggle theme">
    <i class="fas fa-moon" id="themeIcon"></i>
</button>

<div class="page-wrapper">
    <div class="card">

        <!-- Progress Steps -->
        <div class="steps-row">
            <div class="step-pill active" id="step-pill-1">
                <div class="step-circle" id="step-circle-1">1</div>
                <span class="step-label">Email</span>
            </div>
            <div class="step-line"><div class="step-line-fill" id="line-1"></div></div>
            <div class="step-pill" id="step-pill-2">
                <div class="step-circle" id="step-circle-2">2</div>
                <span class="step-label">Verify</span>
            </div>
            <div class="step-line"><div class="step-line-fill" id="line-2"></div></div>
            <div class="step-pill" id="step-pill-3">
                <div class="step-circle" id="step-circle-3">3</div>
                <span class="step-label">Reset</span>
            </div>
        </div>

        <!-- ==========================================
             STEP 1 — Enter Email
        ========================================== -->
        <div class="step-panel active" id="panel-1">
            <div class="icon-header">
                <div class="icon-wrap">
                    <i class="fas fa-key"></i>
                </div>
                <h1 class="step-title">Forgot Password?</h1>
                <p class="step-desc">No worries! Enter your email and we'll send a verification code to reset your password.</p>
            </div>

            <div class="alert" id="alert1"></div>

            <form id="emailForm">
                <div class="form-group">
                    <label class="form-label" for="emailInput">Email Address</label>
                    <div class="input-wrap">
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="email"
                               id="emailInput"
                               class="form-input"
                               placeholder="your@email.com"
                               autocomplete="email"
                               required>
                    </div>
                    <div class="error-msg" id="emailError">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="emailErrorText">Please enter a valid email</span>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="sendBtn">
                    <span class="btn-text"><i class="fas fa-paper-plane"></i> Send Code</span>
                    <span class="btn-loader"><i class="fas fa-circle-notch"></i> Sending...</span>
                </button>
            </form>

            <a href="/login" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to Sign In
            </a>
        </div>

        <!-- ==========================================
             STEP 2 — Verify Code
        ========================================== -->
        <div class="step-panel" id="panel-2">
            <div class="icon-header">
                <div class="icon-wrap">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h1 class="step-title">Check Your Email</h1>
                <p class="step-desc">We sent a 6-digit code to <strong id="emailDisplay">your email</strong>. Enter it below to continue.</p>
            </div>

            <div class="alert" id="alert2"></div>

            <form id="otpForm">
                <div class="form-group">
                    <label class="form-label">Verification Code</label>
                    <div class="otp-row">
                        <input type="text" class="otp-input" maxlength="1" data-index="0" inputmode="numeric">
                        <input type="text" class="otp-input" maxlength="1" data-index="1" inputmode="numeric">
                        <input type="text" class="otp-input" maxlength="1" data-index="2" inputmode="numeric">
                        <input type="text" class="otp-input" maxlength="1" data-index="3" inputmode="numeric">
                        <input type="text" class="otp-input" maxlength="1" data-index="4" inputmode="numeric">
                        <input type="text" class="otp-input" maxlength="1" data-index="5" inputmode="numeric">
                    </div>
                </div>

                <div class="resend-row">
                    Didn't receive it?
                    <button type="button" class="resend-btn" id="resendBtn" disabled>
                        Resend in <span id="resendTimer">60s</span>
                    </button>
                </div>

                <button type="submit" class="btn-primary" id="verifyBtn">
                    <span class="btn-text"><i class="fas fa-check"></i> Verify Code</span>
                    <span class="btn-loader"><i class="fas fa-circle-notch"></i> Verifying...</span>
                </button>
            </form>

            <a href="#" class="back-link" id="backToEmail">
                <i class="fas fa-arrow-left"></i> Use a different email
            </a>
        </div>

        <!-- ==========================================
             STEP 3 — New Password
        ========================================== -->
        <div class="step-panel" id="panel-3">
            <div class="icon-header">
                <div class="icon-wrap">
                    <i class="fas fa-lock"></i>
                </div>
                <h1 class="step-title">New Password</h1>
                <p class="step-desc">Choose a strong password for your account.</p>
            </div>

            <div class="alert" id="alert3"></div>

            <form id="resetForm">
                <!-- New Password -->
                <div class="form-group">
                    <label class="form-label" for="newPassword">New Password</label>
                    <div class="input-wrap">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password"
                               id="newPassword"
                               class="form-input"
                               placeholder="Create a strong password"
                               autocomplete="new-password">
                        <button type="button" class="pw-toggle" onclick="togglePw('newPassword', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="strength-bar-wrap">
                        <div class="strength-bar">
                            <div class="strength-fill" id="strengthFill"></div>
                        </div>
                        <span class="strength-text" id="strengthText">Enter a password</span>
                    </div>
                    <div class="req-list">
                        <div class="req-item" id="req-len">
                            <i class="fas fa-circle"></i> 8+ characters
                        </div>
                        <div class="req-item" id="req-upper">
                            <i class="fas fa-circle"></i> Uppercase
                        </div>
                        <div class="req-item" id="req-lower">
                            <i class="fas fa-circle"></i> Lowercase
                        </div>
                        <div class="req-item" id="req-num">
                            <i class="fas fa-circle"></i> Number
                        </div>
                        <div class="req-item" id="req-special">
                            <i class="fas fa-circle"></i> Special char
                        </div>
                    </div>
                    <div class="error-msg" id="pwError">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="pwErrorText">Password is too weak</span>
                    </div>
                </div>

                <!-- Confirm Password -->
                <div class="form-group">
                    <label class="form-label" for="confirmPassword">Confirm Password</label>
                    <div class="input-wrap">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password"
                               id="confirmPassword"
                               class="form-input"
                               placeholder="Repeat your password"
                               autocomplete="new-password">
                        <button type="button" class="pw-toggle" onclick="togglePw('confirmPassword', this)">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="error-msg" id="confirmError">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Passwords do not match</span>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="resetBtn">
                    <span class="btn-text"><i class="fas fa-check-circle"></i> Reset Password</span>
                    <span class="btn-loader"><i class="fas fa-circle-notch"></i> Resetting...</span>
                </button>
            </form>
        </div>

        <!-- ==========================================
             STEP 4 — Success
        ========================================== -->
        <div class="step-panel" id="panel-success">
            <div class="success-state">
                <div class="success-checkmark">
                    <i class="fas fa-check"></i>
                </div>
                <h2 class="success-title">Password Reset!</h2>
                <p class="success-desc">
                    Your password has been successfully reset.<br>
                    You can now sign in with your new password.
                </p>
                <a href="/login" class="btn-login">
                    <i class="fas fa-sign-in-alt"></i> Go to Sign In
                </a>
            </div>
        </div>

    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
    // ==========================================
    // Theme
    // ==========================================
    const $html = document.documentElement;

    function applyTheme(t) {
        if (t === 'light') {
            $html.classList.add('light-theme');
            document.getElementById('themeIcon').className = 'fas fa-sun';
        } else {
            $html.classList.remove('light-theme');
            document.getElementById('themeIcon').className = 'fas fa-moon';
        }
        localStorage.setItem('chatbot-theme', t);
    }

    applyTheme(localStorage.getItem('chatbot-theme') || 'dark');

    document.getElementById('themeToggle').addEventListener('click', function() {
        applyTheme($html.classList.contains('light-theme') ? 'dark' : 'light');
    });

    // ==========================================
    // Toast
    // ==========================================
    function showToast(msg, type = 'info') {
        const t = document.getElementById('toast');
        t.className = 'toast ' + type;
        t.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${msg}`;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3500);
    }

    // ==========================================
    // Alert
    // ==========================================
    function showAlert(id, msg, type) {
        const el = document.getElementById(id);
        el.className = 'alert show ' + type;
        el.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i> ${msg}`;
    }

    function hideAlert(id) {
        document.getElementById(id).className = 'alert';
    }

    // ==========================================
    // Step Navigation
    // ==========================================
    let currentStep = 1;

    function goToStep(step) {
        // Hide all panels
        document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('active'));

        if (step === 'success') {
            document.getElementById('panel-success').classList.add('active');
            return;
        }

        document.getElementById('panel-' + step).classList.add('active');
        currentStep = step;

        // Update progress UI
        for (let i = 1; i <= 3; i++) {
            const pill   = document.getElementById('step-pill-' + i);
            const circle = document.getElementById('step-circle-' + i);

            pill.classList.remove('active', 'completed');

            if (i < step) {
                pill.classList.add('completed');
                circle.innerHTML = '<i class="fas fa-check" style="font-size:11px"></i>';
            } else if (i === step) {
                pill.classList.add('active');
                circle.textContent = i;
            } else {
                circle.textContent = i;
            }
        }

        // Fill lines
        for (let i = 1; i <= 2; i++) {
            document.getElementById('line-' + i).style.width = i < step ? '100%' : '0%';
        }
    }

    // ==========================================
    // Helpers: loading state
    // ==========================================
    function setLoading(btnId, loading) {
        const btn = document.getElementById(btnId);
        btn.disabled = loading;
        btn.querySelector('.btn-text').style.display = loading ? 'none' : 'flex';
        btn.querySelector('.btn-loader').style.display = loading ? 'flex' : 'none';
    }

    // ==========================================
    // STEP 1 — Email Form
    // ==========================================
    let userEmail = '';

    document.getElementById('emailForm').addEventListener('submit', function(e) {
        e.preventDefault();
        hideAlert('alert1');

        const emailVal = document.getElementById('emailInput').value.trim();
        const emailErr = document.getElementById('emailError');
        const emailInp = document.getElementById('emailInput');

        // Validate
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailVal || !emailRegex.test(emailVal)) {
            emailInp.classList.add('invalid');
            emailErr.classList.add('show');
            document.getElementById('emailErrorText').textContent = 'Please enter a valid email address';
            return;
        }

        emailInp.classList.remove('invalid');
        emailErr.classList.remove('show');
        setLoading('sendBtn', true);

        // AJAX to Flask
        fetch('/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: emailVal })
        })
        .then(r => r.json())
        .then(data => {
            setLoading('sendBtn', false);
            if (data.success) {
                userEmail = emailVal;
                document.getElementById('emailDisplay').textContent = emailVal;
                goToStep(2);
                startResendTimer();
                showToast('Code sent to ' + emailVal, 'success');
            } else {
                showAlert('alert1', data.message || 'Email not found', 'error');
            }
        })
        .catch(() => {
            setLoading('sendBtn', false);
            showAlert('alert1', 'Network error. Please try again.', 'error');
        });
    });

    // Input clean on focus
    document.getElementById('emailInput').addEventListener('focus', function() {
        this.classList.remove('invalid');
        document.getElementById('emailError').classList.remove('show');
    });

    // ==========================================
    // STEP 2 — OTP Inputs
    // ==========================================
    const otpInputs = document.querySelectorAll('.otp-input');

    otpInputs.forEach((input, i) => {
        input.addEventListener('input', function(e) {
            const val = e.target.value.replace(/\D/g, '');
            e.target.value = val;

            if (val) {
                e.target.classList.add('filled');
                e.target.classList.remove('invalid');
                if (i < otpInputs.length - 1) otpInputs[i + 1].focus();
            } else {
                e.target.classList.remove('filled');
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !this.value && i > 0) {
                otpInputs[i - 1].focus();
                otpInputs[i - 1].value = '';
                otpInputs[i - 1].classList.remove('filled');
            }
        });

        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '');
            paste.split('').slice(0, 6).forEach((ch, idx) => {
                if (otpInputs[idx]) {
                    otpInputs[idx].value = ch;
                    otpInputs[idx].classList.add('filled');
                }
            });
            const next = Math.min(paste.length, 5);
            otpInputs[next].focus();
        });
    });

    function getOtpValue() {
        return Array.from(otpInputs).map(i => i.value).join('');
    }

    // OTP Form Submit
    document.getElementById('otpForm').addEventListener('submit', function(e) {
        e.preventDefault();
        hideAlert('alert2');

        const code = getOtpValue();
        if (code.length < 6) {
            otpInputs.forEach(i => i.classList.add('invalid'));
            showAlert('alert2', 'Please enter the complete 6-digit code', 'error');
            return;
        }

        setLoading('verifyBtn', true);

        fetch('/verify-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail, code: code })
        })
        .then(r => r.json())
        .then(data => {
            setLoading('verifyBtn', false);
            if (data.success) {
                goToStep(3);
                showToast('Code verified!', 'success');
            } else {
                otpInputs.forEach(i => i.classList.add('invalid'));
                showAlert('alert2', data.message || 'Invalid code. Please try again.', 'error');
            }
        })
        .catch(() => {
            setLoading('verifyBtn', false);
            showAlert('alert2', 'Network error. Please try again.', 'error');
        });
    });

    // Back to email
    document.getElementById('backToEmail').addEventListener('click', function(e) {
        e.preventDefault();
        otpInputs.forEach(i => { i.value = ''; i.classList.remove('filled','invalid'); });
        goToStep(1);
    });

    // Resend timer
    let resendInterval;

    function startResendTimer() {
        let seconds = 60;
        const btn   = document.getElementById('resendBtn');
        const timer = document.getElementById('resendTimer');

        btn.disabled = true;
        btn.innerHTML = 'Resend in <span id="resendTimer">' + seconds + 's</span>';

        clearInterval(resendInterval);
        resendInterval = setInterval(() => {
            seconds--;
            const t = document.getElementById('resendTimer');
            if (t) t.textContent = seconds + 's';

            if (seconds <= 0) {
                clearInterval(resendInterval);
                btn.disabled = false;
                btn.textContent = 'Resend Code';
            }
        }, 1000);
    }

    document.getElementById('resendBtn').addEventListener('click', function() {
        if (this.disabled) return;

        fetch('/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                otpInputs.forEach(i => { i.value = ''; i.classList.remove('filled','invalid'); });
                startResendTimer();
                showToast('New code sent!', 'success');
            } else {
                showAlert('alert2', 'Could not resend code. Try again.', 'error');
            }
        });
    });

    // ==========================================
    // STEP 3 — Password Strength & Reset
    // ==========================================
    document.getElementById('newPassword').addEventListener('input', function() {
        checkStrength(this.value);
        this.classList.remove('invalid');
        document.getElementById('pwError').classList.remove('show');
    });

    function checkStrength(pw) {
        const fill = document.getElementById('strengthFill');
        const text = document.getElementById('strengthText');

        const checks = {
            len:     pw.length >= 8,
            upper:   /[A-Z]/.test(pw),
            lower:   /[a-z]/.test(pw),
            num:     /[0-9]/.test(pw),
            special: /[^a-zA-Z0-9]/.test(pw)
        };

        // Update requirements
        Object.entries(checks).forEach(([k, v]) => {
            const el = document.getElementById('req-' + k);
            if (el) {
                el.classList.toggle('met', v);
                el.querySelector('i').className = v ? 'fas fa-check-circle' : 'fas fa-circle';
            }
        });

        const score = Object.values(checks).filter(Boolean).length;

        fill.className = 'strength-fill';
        text.className = 'strength-text';

        if (!pw) {
            text.textContent = 'Enter a password';
            return;
        } else if (score <= 1) {
            fill.classList.add('weak');    text.classList.add('weak');    text.textContent = 'Weak';
        } else if (score === 2) {
            fill.classList.add('fair');    text.classList.add('fair');    text.textContent = 'Fair';
        } else if (score === 3 || score === 4) {
            fill.classList.add('good');    text.classList.add('good');    text.textContent = 'Good';
        } else {
            fill.classList.add('strong');  text.classList.add('strong');  text.textContent = 'Strong';
        }
    }

    document.getElementById('confirmPassword').addEventListener('input', function() {
        this.classList.remove('invalid');
        document.getElementById('confirmError').classList.remove('show');
    });

    document.getElementById('resetForm').addEventListener('submit', function(e) {
        e.preventDefault();
        hideAlert('alert3');

        const pw  = document.getElementById('newPassword').value;
        const cpw = document.getElementById('confirmPassword').value;
        let valid = true;

        if (pw.length < 8 || !/[A-Z]/.test(pw) || !/[0-9]/.test(pw)) {
            document.getElementById('newPassword').classList.add('invalid');
            document.getElementById('pwError').classList.add('show');
            document.getElementById('pwErrorText').textContent = 'Password must have 8+ chars, uppercase & number';
            valid = false;
        }

        if (pw !== cpw) {
            document.getElementById('confirmPassword').classList.add('invalid');
            document.getElementById('confirmError').classList.add('show');
            valid = false;
        }

        if (!valid) return;

        setLoading('resetBtn', true);

        fetch('/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail, password: pw })
        })
        .then(r => r.json())
        .then(data => {
            setLoading('resetBtn', false);
            if (data.success) {
                goToStep('success');
            } else {
                showAlert('alert3', data.message || 'Failed to reset password', 'error');
            }
        })
        .catch(() => {
            setLoading('resetBtn', false);
            showAlert('alert3', 'Network error. Please try again.', 'error');
        });
    });

    // Toggle password visibility
    function togglePw(fieldId, btn) {
        const input = document.getElementById(fieldId);
        const icon  = btn.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }
</script>
</body>
</html>